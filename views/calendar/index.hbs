<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
        <i class="bi bi-calendar3"></i> {{calendarTitle}}
    </h1>
    <div class="btn-group" role="group">
        {{#if isAdmin}}
        <a href="/sessions/create{{#if currentDate.date}}?session_date={{currentDate.date}}{{/if}}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> New Session
        </a>
        {{/if}}
    </div>
</div>

<!-- Navigation and View Controls -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-4">
                <!-- Navigation -->
                <div class="btn-group" role="group">
                    <a href="?view={{view}}{{#if navigation.prev}}{{#if navigation.prev.year}}&year={{navigation.prev.year}}&month={{navigation.prev.month}}{{/if}}{{#if navigation.prev.week}}&week={{navigation.prev.week}}{{/if}}{{#if navigation.prev.date}}&date={{navigation.prev.date}}{{/if}}{{/if}}{{#if filters.property_id}}&property_id={{filters.property_id}}{{/if}}" class="btn btn-outline-secondary">
                        <i class="bi bi-chevron-left"></i> Previous
                    </a>
                    <a href="/calendar?view={{view}}{{#ifCond view '==' 'monthly'}}&year={{getCurrentDate 'year'}}&month={{getCurrentDate 'month'}}{{/ifCond}}{{#ifCond view '==' 'weekly'}}&week={{getCurrentDate 'week'}}{{/ifCond}}{{#ifCond view '==' 'daily'}}&date={{getCurrentDate 'date'}}{{/ifCond}}{{#if filters.property_id}}&property_id={{filters.property_id}}{{/if}}" class="btn btn-outline-secondary">Today</a>
                    <a href="?view={{view}}{{#if navigation.next}}{{#if navigation.next.year}}&year={{navigation.next.year}}&month={{navigation.next.month}}{{/if}}{{#if navigation.next.week}}&week={{navigation.next.week}}{{/if}}{{#if navigation.next.date}}&date={{navigation.next.date}}{{/if}}{{/if}}{{#if filters.property_id}}&property_id={{filters.property_id}}{{/if}}" class="btn btn-outline-secondary">
                        Next <i class="bi bi-chevron-right"></i>
                    </a>
                </div>
            </div>
            
            <div class="col-md-4 text-center">
                <!-- View Toggle -->
                <div class="btn-group" role="group">
                    <a href="?view=monthly{{#if currentDate.year}}&year={{currentDate.year}}&month={{currentDate.month}}{{/if}}{{#if filters.property_id}}&property_id={{filters.property_id}}{{/if}}" 
                       class="btn {{#ifCond view '==' 'monthly'}}btn-primary{{else}}btn-outline-primary{{/ifCond}}">Monthly</a>
                    <a href="?view=weekly{{#if currentDate.week}}&week={{currentDate.week}}{{else}}&week={{getWeekStart currentDate.year currentDate.month}}{{/if}}{{#if filters.property_id}}&property_id={{filters.property_id}}{{/if}}" 
                       class="btn {{#ifCond view '==' 'weekly'}}btn-primary{{else}}btn-outline-primary{{/ifCond}}">Weekly</a>
                    <a href="?view=daily{{#if currentDate.date}}&date={{currentDate.date}}{{else}}&date={{getCurrentDate}}{{/if}}{{#if filters.property_id}}&property_id={{filters.property_id}}{{/if}}" 
                       class="btn {{#ifCond view '==' 'daily'}}btn-primary{{else}}btn-outline-primary{{/ifCond}}">Daily</a>
                </div>
            </div>
            
            <div class="col-md-4">
                <!-- Property Filter -->
                <div class="d-flex justify-content-end">
                    <select class="form-select" style="max-width: 200px;" onchange="filterByProperty(this.value)">
                        <option value="">All Properties</option>
                        {{#each properties}}
                        <option value="{{id}}" {{#ifCond id '==' ../filters.property_id}}selected{{/ifCond}}>{{name}}</option>
                        {{/each}}
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Calendar Content -->
{{#ifCond view '==' 'monthly'}}
<!-- Monthly Calendar View -->
<div class="card calendar-container">
    <div class="calendar-header">
        <div class="row text-center">
            {{#each calendarData.daysOfWeek}}
            <div class="col fw-bold py-2">{{this}}</div>
            {{/each}}
        </div>
    </div>
    <div class="calendar-body">
        {{#each calendarData.weeks}}
        <div class="row g-0">
            {{#each this}}
            <div class="col calendar-day {{#unless isCurrentMonth}}other-month{{/unless}} {{#if isToday}}today{{/if}}" 
                 data-date="{{fullDate}}" onclick="viewDayDetails('{{fullDate}}')">
                <div class="day-number">{{date}}</div>
                <div class="day-sessions">
                    {{#each sessions}}
                    <div class="calendar-session" 
                         style="background-color: {{supportTypeColor support_type}}; color: white;"
                         data-session-id="{{id}}"
                         onclick="event.stopPropagation(); viewSession('{{id}}');"
                         title="{{formatTime start_time}} - {{resident_first_name}} {{resident_last_name}}">
                        <small>{{formatTime start_time}} {{resident_first_name}}</small>
                    </div>
                    {{/each}}
                </div>
            </div>
            {{/each}}
        </div>
        {{/each}}
    </div>
</div>
{{/ifCond}}

{{#ifCond view '==' 'weekly'}}
<!-- Weekly Calendar View -->
<div class="card">
    <div class="weekly-calendar">
        <!-- Header with days -->
        <div class="time-slot"></div>
        {{#each calendarData.days}}
        <div class="calendar-cell header {{#if isToday}}bg-primary{{else}}bg-secondary{{/if}}">
            <div>{{dayName}}</div>
            <div>{{date}}</div>
        </div>
        {{/each}}
        
        <!-- Time slots and sessions -->
        {{#each calendarData.timeSlots}}
        <div class="time-slot">{{this}}</div>
        {{#each ../calendarData.days}}
        <div class="calendar-cell" data-date="{{fullDate}}" data-time="{{../this}}">
            {{#each sessions}}
            <div class="calendar-session w-100" 
                 style="background-color: {{supportTypeColor support_type}}; color: white;"
                 onclick="viewSession('{{id}}')"
                 title="{{formatTime start_time}} - {{resident_first_name}} {{resident_last_name}} - {{supportTypeLabel support_type}}">
                <small>{{formatTime start_time}} {{resident_first_name}}</small>
            </div>
            {{/each}}
        </div>
        {{/each}}
        {{/each}}
    </div>
</div>
{{/ifCond}}

{{#ifCond view '==' 'daily'}}
<!-- Daily Calendar View -->
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Schedule</h5>
            </div>
            <div class="card-body">
                {{#if calendarData.sessions}}
                <div class="timeline">
                    {{#each calendarData.sessions}}
                    <div class="timeline-item mb-3 p-3 border rounded" 
                         style="border-left: 4px solid {{supportTypeColor support_type}} !important;">
                        <div class="row">
                            <div class="col-md-3">
                                <strong>{{formatTime start_time}} - {{formatTime end_time}}</strong>
                                <br><small class="text-muted">{{duration_minutes}} minutes</small>
                            </div>
                            <div class="col-md-6">
                                <h6 class="mb-1">{{resident_first_name}} {{resident_last_name}}</h6>
                                <p class="mb-1">
                                    <span class="badge" style="background-color: {{supportTypeColor support_type}}">
                                        {{supportTypeLabel support_type}}
                                    </span>
                                </p>
                                <small class="text-muted">
                                    <i class="bi bi-person"></i> {{worker_first_name}} {{worker_last_name}} â€¢ 
                                    <i class="bi bi-building"></i> {{property_name}}
                                </small>
                                {{#if notes}}
                                <p class="mt-2 mb-0"><small>{{notes}}</small></p>
                                {{/if}}
                            </div>
                            <div class="col-md-3 text-end">
                                <span class="badge 
                                    {{#eq status 'completed'}}bg-success{{/eq}}
                                    {{#eq status 'planned'}}bg-primary{{/eq}}
                                    {{#eq status 'cancelled'}}bg-danger{{/eq}}
                                    {{#eq status 'no_show'}}bg-warning{{/eq}}">
                                    {{capitalize status}}
                                </span>
                                <div class="mt-2">
                                    <a href="/sessions/{{id}}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    {{#if ../isAdmin}}
                                    <a href="/sessions/{{id}}/edit" class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    {{/if}}
                                </div>
                            </div>
                        </div>
                    </div>
                    {{/each}}
                </div>
                {{else}}
                <div class="text-center py-5">
                    <i class="bi bi-calendar-x display-4 text-muted"></i>
                    <h5 class="mt-3">No Sessions Scheduled</h5>
                    <p class="text-muted">There are no sessions scheduled for this day.</p>
                    {{#if isAdmin}}
                    <a href="/sessions/create?session_date={{currentDate.date}}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Schedule Session
                    </a>
                    {{/if}}
                </div>
                {{/if}}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Day Summary</h5>
            </div>
            <div class="card-body">
                {{#if calendarData.sessions}}
                <div class="row text-center mb-3">
                    <div class="col-6">
                        <h4 class="text-primary">{{calendarData.sessions.length}}</h4>
                        <small class="text-muted">Total Sessions</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-success">{{calculateTotalHours calendarData.sessions}}</h4>
                        <small class="text-muted">Total Hours</small>
                    </div>
                </div>
                
                <h6>By Support Type:</h6>
                {{#each (groupByType calendarData.sessions)}}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="badge" style="background-color: {{supportTypeColor @key}}">
                        {{supportTypeLabel @key}}
                    </span>
                    <span>{{this}} sessions</span>
                </div>
                {{/each}}
                {{else}}
                <p class="text-muted text-center">No sessions scheduled</p>
                {{/if}}
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                {{#if isAdmin}}
                <div class="d-grid gap-2">
                    <a href="/sessions/create{{#if currentDate.date}}?session_date={{currentDate.date}}{{/if}}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Schedule Session
                    </a>
                    <a href="/sessions?date_from={{currentDate.date}}&date_to={{currentDate.date}}" class="btn btn-outline-secondary">
                        <i class="bi bi-list"></i> View All Sessions
                    </a>
                </div>
                {{/if}}
            </div>
        </div>
    </div>
</div>
{{/ifCond}}

<!-- Legend -->
<div class="card mt-4">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h6 class="mb-2">Support Types:</h6>
                <div class="d-flex flex-wrap gap-2">
                    <span class="badge" style="background-color: #dc3545">Mental Health Support</span>
                    <span class="badge" style="background-color: #28a745">Domestic & Independence Support</span>
                    <span class="badge" style="background-color: #007bff">Activity Based Group Support</span>
                </div>
            </div>
            <div class="col-md-6">
                <h6 class="mb-2">Status:</h6>
                <div class="d-flex flex-wrap gap-2">
                    <span class="badge bg-primary">Planned</span>
                    <span class="badge bg-success">Completed</span>
                    <span class="badge bg-danger">Cancelled</span>
                    <span class="badge bg-warning">No Show</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function viewSession(sessionId) {
    window.location.href = `/sessions/${sessionId}`;
}

function viewDayDetails(date) {
    window.location.href = `?view=daily&date=${date}{{#if filters.property_id}}&property_id={{filters.property_id}}{{/if}}`;
}

function filterByProperty(propertyId) {
    const currentUrl = new URL(window.location);
    if (propertyId) {
        currentUrl.searchParams.set('property_id', propertyId);
    } else {
        currentUrl.searchParams.delete('property_id');
    }
    window.location.href = currentUrl.toString();
}

function goToToday() {
    console.log('goToToday called');
    const today = new Date();
    const currentView = '{{view}}';
    console.log('Current view:', currentView);
    
    let url = '/calendar?';
    
    if (currentView === 'monthly') {
        url += `view=monthly&year=${today.getFullYear()}&month=${today.getMonth() + 1}`;
    } else if (currentView === 'weekly') {
        const weekStart = new Date(today);
        weekStart.setDate(weekStart.getDate() - weekStart.getDay());
        url += `view=weekly&week=${weekStart.toISOString().split('T')[0]}`;
    } else if (currentView === 'daily') {
        url += `view=daily&date=${today.toISOString().split('T')[0]}`;
    } else {
        // Default to monthly if view is unknown
        url += `view=monthly&year=${today.getFullYear()}&month=${today.getMonth() + 1}`;
    }
    
    {{#if filters.property_id}}
    url += '&property_id={{filters.property_id}}';
    {{/if}}
    
    console.log('Navigating to:', url);
    window.location.href = url;
}
</script>